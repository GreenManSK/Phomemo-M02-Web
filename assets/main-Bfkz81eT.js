(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const v=Symbol("Comlink.proxy"),D=Symbol("Comlink.endpoint"),_=Symbol("Comlink.releaseProxy"),u=Symbol("Comlink.finalizer"),S=Symbol("Comlink.thrown"),$=r=>typeof r=="object"&&r!==null||typeof r=="function",U={canHandle:r=>$(r)&&r[v],serialize(r){const{port1:e,port2:t}=new MessageChannel;return I(r,e),[t,[t]]},deserialize(r){return r.start(),G(r)}},X={canHandle:r=>$(r)&&S in r,serialize({value:r}){let e;return r instanceof Error?e={isError:!0,value:{message:r.message,name:r.name,stack:r.stack}}:e={isError:!1,value:r},[e,[]]},deserialize(r){throw r.isError?Object.assign(new Error(r.value.message),r.value):r.value}},x=new Map([["proxy",U],["throw",X]]);function j(r,e){for(const t of r)if(e===t||t==="*"||t instanceof RegExp&&t.test(e))return!0;return!1}function I(r,e=globalThis,t=["*"]){e.addEventListener("message",function E(i){if(!i||!i.data)return;if(!j(t,i.origin)){console.warn(`Invalid origin '${i.origin}' for comlink proxy`);return}const{id:w,type:k,path:c}=Object.assign({path:[]},i.data),l=(i.data.argumentList||[]).map(M);let f;try{const b=c.slice(0,-1).reduce((m,o)=>m[o],r),g=c.reduce((m,o)=>m[o],r);switch(k){case"GET":f=g;break;case"SET":b[c.slice(-1)[0]]=M(i.data.value),f=!0;break;case"APPLY":f=g.apply(b,l);break;case"CONSTRUCT":{const m=new g(...l);f=Q(m)}break;case"ENDPOINT":{const{port1:m,port2:o}=new MessageChannel;I(r,o),f=K(m,[m])}break;case"RELEASE":f=void 0;break;default:return}}catch(b){f={value:b,[S]:0}}Promise.resolve(f).catch(b=>({value:b,[S]:0})).then(b=>{const[g,m]=R(b);e.postMessage(Object.assign(Object.assign({},g),{id:w}),m),k==="RELEASE"&&(e.removeEventListener("message",E),z(e),u in r&&typeof r[u]=="function"&&r[u]())}).catch(b=>{const[g,m]=R({value:new TypeError("Unserializable return value"),[S]:0});e.postMessage(Object.assign(Object.assign({},g),{id:w}),m)})}),e.start&&e.start()}function B(r){return r.constructor.name==="MessagePort"}function z(r){B(r)&&r.close()}function G(r,e){const t=new Map;return r.addEventListener("message",function(i){const{data:w}=i;if(!w||!w.id)return;const k=t.get(w.id);if(k)try{k(w)}finally{t.delete(w.id)}}),V(r,t,[],e)}function C(r){if(r)throw new Error("Proxy has been released and is not useable")}function F(r){return A(r,new Map,{type:"RELEASE"}).then(()=>{z(r)})}const O=new WeakMap,T="FinalizationRegistry"in globalThis&&new FinalizationRegistry(r=>{const e=(O.get(r)||0)-1;O.set(r,e),e===0&&F(r)});function Y(r,e){const t=(O.get(e)||0)+1;O.set(e,t),T&&T.register(r,e,r)}function q(r){T&&T.unregister(r)}function V(r,e,t=[],E=function(){}){let i=!1;const w=new Proxy(E,{get(k,c){if(C(i),c===_)return()=>{q(w),F(r),e.clear(),i=!0};if(c==="then"){if(t.length===0)return{then:()=>w};const l=A(r,e,{type:"GET",path:t.map(f=>f.toString())}).then(M);return l.then.bind(l)}return V(r,e,[...t,c])},set(k,c,l){C(i);const[f,b]=R(l);return A(r,e,{type:"SET",path:[...t,c].map(g=>g.toString()),value:f},b).then(M)},apply(k,c,l){C(i);const f=t[t.length-1];if(f===D)return A(r,e,{type:"ENDPOINT"}).then(M);if(f==="bind")return V(r,e,t.slice(0,-1));const[b,g]=H(l);return A(r,e,{type:"APPLY",path:t.map(m=>m.toString()),argumentList:b},g).then(M)},construct(k,c){C(i);const[l,f]=H(c);return A(r,e,{type:"CONSTRUCT",path:t.map(b=>b.toString()),argumentList:l},f).then(M)}});return Y(w,r),w}function J(r){return Array.prototype.concat.apply([],r)}function H(r){const e=r.map(R);return[e.map(t=>t[0]),J(e.map(t=>t[1]))]}const N=new WeakMap;function K(r,e){return N.set(r,e),r}function Q(r){return Object.assign(r,{[v]:!0})}function R(r){for(const[e,t]of x)if(t.canHandle(r)){const[E,i]=t.serialize(r);return[{type:"HANDLER",name:e,value:E},i]}return[{type:"RAW",value:r},N.get(r)||[]]}function M(r){switch(r.type){case"HANDLER":return x.get(r.name).deserialize(r.value);case"RAW":return r.value}}function A(r,e,t,E){return new Promise(i=>{const w=Z();e.set(w,i),r.start&&r.start(),r.postMessage(Object.assign({id:w},t),E)})}function Z(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}async function P(r,e,t){const E=Math.max(1,Math.min(100,t.widthPercentage??100)),i=Math.round(e*(E/100));let w;t.rotation===90||t.rotation===270?w=Math.round(i*(r.width/r.height)):w=Math.round(i*(r.height/r.width));const k=Math.max(0,Math.min(100,t.heightPercentage??100)),c=Math.round(w*(k/100)),l=new OffscreenCanvas(e,w),f=l.getContext("2d");if(!f)throw new Error("Failed to get canvas context");f.fillStyle="#ffffff",f.fillRect(0,0,l.width,l.height),console.log(`Drawing image to canvas: ${r.width}x${r.height} -> ${l.width}x${l.height} (${e} pixels wide, image at ${E}% width) with options:`,t);const b=Math.round((e-i)/2);f.filter=`contrast(${t.contrast}) brightness(${t.exposure})`,t.rotation!==0?(f.save(),f.translate(l.width/2,l.height/2),f.rotate(t.rotation*Math.PI/180),t.rotation===90||t.rotation===270?f.drawImage(r,-w/2,-i/2,w,i):f.drawImage(r,-i/2,-w/2,i,w),f.restore()):f.drawImage(r,b,0,i,w),f.filter="none";const g=f.getImageData(0,0,l.width,c),m=new Uint8ClampedArray(c*e/8);switch(t.algorithm){case"Basic":{const o=(a,n)=>g.data[(n*l.width+a)*4]+g.data[(n*l.width+a)*4+1]+g.data[(n*l.width+a)*4+2]<t.threshold*3;for(let a=0;a<c;a++)for(let n=0;n<e/8;n++)for(let s=0;s<8;s++){const h=n*8+s;if(h>=e)break;const d=o(h,a),y=t.invert?d?0:1:d?1:0;m[a*e/8+n]|=y<<7-s}break}case"Dither":{const o=new Float32Array(e*c);for(let a=0;a<c;a++)for(let n=0;n<e;n++){const s=(a*l.width+n)*4;o[a*e+n]=(g.data[s]+g.data[s+1]+g.data[s+2])/3}for(let a=0;a<c;a++)for(let n=0;n<e;n++){const s=a*e+n,h=o[s],d=h<t.threshold?0:255;o[s]=d;const y=h-d;n+1<e&&(o[s+1]+=y*7/16),a+1<c&&(n>0&&(o[s+e-1]+=y*3/16),o[s+e]+=y*5/16,n+1<e&&(o[s+e+1]+=y*1/16))}for(let a=0;a<c;a++)for(let n=0;n<e/8;n++)for(let s=0;s<8;s++){const h=n*8+s;if(h>=e)break;const d=o[a*e+h]<t.threshold,y=t.invert?d?0:1:d?1:0;m[a*e/8+n]|=y<<7-s}break}case"Atkinson":{const o=new Float32Array(e*c);for(let a=0;a<c;a++)for(let n=0;n<e;n++){const s=(a*l.width+n)*4;o[a*e+n]=(g.data[s]+g.data[s+1]+g.data[s+2])/3}for(let a=0;a<c;a++)for(let n=0;n<e;n++){const s=a*e+n,h=o[s],d=h<t.threshold?0:255;o[s]=d;const y=h-d;n+1<e&&(o[s+1]+=y/8),n+2<e&&(o[s+2]+=y/8),a+1<c&&(n>0&&(o[s+e-1]+=y/8),o[s+e]+=y/8,n+1<e&&(o[s+e+1]+=y/8)),a+2<c&&(o[s+2*e]+=y/8)}for(let a=0;a<c;a++)for(let n=0;n<e/8;n++)for(let s=0;s<8;s++){const h=n*8+s;if(h>=e)break;const d=o[a*e+h]<t.threshold,y=t.invert?d?0:1:d?1:0;m[a*e/8+n]|=y<<7-s}break}case"Bayer":{const o=[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]];for(let a=0;a<c;a++)for(let n=0;n<e/8;n++)for(let s=0;s<8;s++){const h=n*8+s;if(h>=e)break;const d=(a*l.width+h)*4,y=(g.data[d]+g.data[d+1]+g.data[d+2])/3,p=(o[a%8][h%8]-31.5)*2,W=t.threshold+p,L=y<W,ee=t.invert?L?0:1:L?1:0;m[a*e/8+n]|=ee<<7-s}break}case"SierraLite":{const o=new Float32Array(e*c);for(let a=0;a<c;a++)for(let n=0;n<e;n++){const s=(a*l.width+n)*4;o[a*e+n]=(g.data[s]+g.data[s+1]+g.data[s+2])/3}for(let a=0;a<c;a++)for(let n=0;n<e;n++){const s=a*e+n,h=o[s],d=h<t.threshold?0:255;o[s]=d;const y=h-d;n+1<e&&(o[s+1]+=y*2/4),a+1<c&&(n>0&&(o[s+e-1]+=y/4),o[s+e]+=y/4)}for(let a=0;a<c;a++)for(let n=0;n<e/8;n++)for(let s=0;s<8;s++){const h=n*8+s;if(h>=e)break;const d=o[a*e+h]<t.threshold,y=t.invert?d?0:1:d?1:0;m[a*e/8+n]|=y<<7-s}break}}if(l.width!==e)throw new Error(`Canvas width ${l.width} does not match output width ${e}`);return console.log(`Image converted to bits: ${e} pixels wide, ${c} pixels high`),{width:e,height:c,bits:m}}I(P)})();
