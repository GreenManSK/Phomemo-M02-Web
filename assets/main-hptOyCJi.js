(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const O=Symbol("Comlink.proxy"),N=Symbol("Comlink.endpoint"),x=Symbol("Comlink.releaseProxy"),C=Symbol("Comlink.finalizer"),m=Symbol("Comlink.thrown"),R=r=>typeof r=="object"&&r!==null||typeof r=="function",H={canHandle:r=>R(r)&&r[O],serialize(r){const{port1:e,port2:s}=new MessageChannel;return S(r,e),[s,[s]]},deserialize(r){return r.start(),_(r)}},L={canHandle:r=>R(r)&&m in r,serialize({value:r}){let e;return r instanceof Error?e={isError:!0,value:{message:r.message,name:r.name,stack:r.stack}}:e={isError:!1,value:r},[e,[]]},deserialize(r){throw r.isError?Object.assign(new Error(r.value.message),r.value):r.value}},I=new Map([["proxy",H],["throw",L]]);function u(r,e){for(const s of r)if(e===s||s==="*"||s instanceof RegExp&&s.test(e))return!0;return!1}function S(r,e=globalThis,s=["*"]){e.addEventListener("message",function l(o){if(!o||!o.data)return;if(!u(s,o.origin)){console.warn(`Invalid origin '${o.origin}' for comlink proxy`);return}const{id:g,type:w,path:h}=Object.assign({path:[]},o.data),c=(o.data.argumentList||[]).map(d);let t;try{const n=h.slice(0,-1).reduce((f,i)=>f[i],r),a=h.reduce((f,i)=>f[i],r);switch(w){case"GET":t=a;break;case"SET":n[h.slice(-1)[0]]=d(o.data.value),t=!0;break;case"APPLY":t=a.apply(n,c);break;case"CONSTRUCT":{const f=new a(...c);t=G(f)}break;case"ENDPOINT":{const{port1:f,port2:i}=new MessageChannel;S(r,i),t=B(f,[f])}break;case"RELEASE":t=void 0;break;default:return}}catch(n){t={value:n,[m]:0}}Promise.resolve(t).catch(n=>({value:n,[m]:0})).then(n=>{const[a,f]=A(n);e.postMessage(Object.assign(Object.assign({},a),{id:g}),f),w==="RELEASE"&&(e.removeEventListener("message",l),V(e),C in r&&typeof r[C]=="function"&&r[C]())}).catch(n=>{const[a,f]=A({value:new TypeError("Unserializable return value"),[m]:0});e.postMessage(Object.assign(Object.assign({},a),{id:g}),f)})}),e.start&&e.start()}function D(r){return r.constructor.name==="MessagePort"}function V(r){D(r)&&r.close()}function _(r,e){const s=new Map;return r.addEventListener("message",function(o){const{data:g}=o;if(!g||!g.id)return;const w=s.get(g.id);if(w)try{w(g)}finally{s.delete(g.id)}}),T(r,s,[],e)}function E(r){if(r)throw new Error("Proxy has been released and is not useable")}function v(r){return b(r,new Map,{type:"RELEASE"}).then(()=>{V(r)})}const k=new WeakMap,M="FinalizationRegistry"in globalThis&&new FinalizationRegistry(r=>{const e=(k.get(r)||0)-1;k.set(r,e),e===0&&v(r)});function U(r,e){const s=(k.get(e)||0)+1;k.set(e,s),M&&M.register(r,e,r)}function X(r){M&&M.unregister(r)}function T(r,e,s=[],l=function(){}){let o=!1;const g=new Proxy(l,{get(w,h){if(E(o),h===x)return()=>{X(g),v(r),e.clear(),o=!0};if(h==="then"){if(s.length===0)return{then:()=>g};const c=b(r,e,{type:"GET",path:s.map(t=>t.toString())}).then(d);return c.then.bind(c)}return T(r,e,[...s,h])},set(w,h,c){E(o);const[t,n]=A(c);return b(r,e,{type:"SET",path:[...s,h].map(a=>a.toString()),value:t},n).then(d)},apply(w,h,c){E(o);const t=s[s.length-1];if(t===N)return b(r,e,{type:"ENDPOINT"}).then(d);if(t==="bind")return T(r,e,s.slice(0,-1));const[n,a]=$(c);return b(r,e,{type:"APPLY",path:s.map(f=>f.toString()),argumentList:n},a).then(d)},construct(w,h){E(o);const[c,t]=$(h);return b(r,e,{type:"CONSTRUCT",path:s.map(n=>n.toString()),argumentList:c},t).then(d)}});return U(g,r),g}function j(r){return Array.prototype.concat.apply([],r)}function $(r){const e=r.map(A);return[e.map(s=>s[0]),j(e.map(s=>s[1]))]}const z=new WeakMap;function B(r,e){return z.set(r,e),r}function G(r){return Object.assign(r,{[O]:!0})}function A(r){for(const[e,s]of I)if(s.canHandle(r)){const[l,o]=s.serialize(r);return[{type:"HANDLER",name:e,value:l},o]}return[{type:"RAW",value:r},z.get(r)||[]]}function d(r){switch(r.type){case"HANDLER":return I.get(r.name).deserialize(r.value);case"RAW":return r.value}}function b(r,e,s,l){return new Promise(o=>{const g=Y();e.set(g,o),r.start&&r.start(),r.postMessage(Object.assign({id:g},s),l)})}function Y(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}async function q(r,e,s){let l;s.rotation===90||s.rotation===270?l=Math.round(e*(r.width/r.height)):l=Math.round(e*(r.height/r.width));const o=new OffscreenCanvas(e,l),g=o.getContext("2d");if(!g)throw new Error("Failed to get canvas context");g.clearRect(0,0,o.width,o.height),console.log(`Drawing image to canvas: ${r.width}x${r.height} -> ${o.width}x${o.height} (${e} pixels wide) with options:`,s),g.filter=`contrast(${s.contrast}) brightness(${s.exposure})`,s.rotation!==0?(g.save(),g.translate(o.width/2,o.height/2),g.rotate(s.rotation*Math.PI/180),s.rotation===90||s.rotation===270?g.drawImage(r,-o.height/2,-o.width/2,o.height,o.width):g.drawImage(r,-o.width/2,-o.height/2,o.width,o.height),g.restore()):g.drawImage(r,0,0,o.width,o.height),g.filter="none";const w=g.getImageData(0,0,o.width,o.height),h=new Uint8ClampedArray(l*e/8);switch(s.algorithm){case"Basic":{const c=(t,n)=>w.data[(n*o.width+t)*4]+w.data[(n*o.width+t)*4+1]+w.data[(n*o.width+t)*4+2]<s.threshold*3;for(let t=0;t<l;t++)for(let n=0;n<e/8;n++)for(let a=0;a<8;a++){const f=n*8+a;if(f>=e)break;const i=c(f,t),y=s.invert?i?0:1:i?1:0;h[t*e/8+n]|=y<<7-a}break}case"Dither":{const c=new Float32Array(e*l);for(let t=0;t<l;t++)for(let n=0;n<e;n++){const a=(t*o.width+n)*4;c[t*e+n]=(w.data[a]+w.data[a+1]+w.data[a+2])/3}for(let t=0;t<l;t++)for(let n=0;n<e;n++){const a=t*e+n,f=c[a],i=f<s.threshold?0:255;c[a]=i;const y=f-i;n+1<e&&(c[a+1]+=y*7/16),t+1<l&&(n>0&&(c[a+e-1]+=y*3/16),c[a+e]+=y*5/16,n+1<e&&(c[a+e+1]+=y*1/16))}for(let t=0;t<l;t++)for(let n=0;n<e/8;n++)for(let a=0;a<8;a++){const f=n*8+a;if(f>=e)break;const i=c[t*e+f]<s.threshold,y=s.invert?i?0:1:i?1:0;h[t*e/8+n]|=y<<7-a}break}case"Atkinson":{const c=new Float32Array(e*l);for(let t=0;t<l;t++)for(let n=0;n<e;n++){const a=(t*o.width+n)*4;c[t*e+n]=(w.data[a]+w.data[a+1]+w.data[a+2])/3}for(let t=0;t<l;t++)for(let n=0;n<e;n++){const a=t*e+n,f=c[a],i=f<s.threshold?0:255;c[a]=i;const y=f-i;n+1<e&&(c[a+1]+=y/8),n+2<e&&(c[a+2]+=y/8),t+1<l&&(n>0&&(c[a+e-1]+=y/8),c[a+e]+=y/8,n+1<e&&(c[a+e+1]+=y/8)),t+2<l&&(c[a+2*e]+=y/8)}for(let t=0;t<l;t++)for(let n=0;n<e/8;n++)for(let a=0;a<8;a++){const f=n*8+a;if(f>=e)break;const i=c[t*e+f]<s.threshold,y=s.invert?i?0:1:i?1:0;h[t*e/8+n]|=y<<7-a}break}case"Bayer":{const c=[[0,32,8,40,2,34,10,42],[48,16,56,24,50,18,58,26],[12,44,4,36,14,46,6,38],[60,28,52,20,62,30,54,22],[3,35,11,43,1,33,9,41],[51,19,59,27,49,17,57,25],[15,47,7,39,13,45,5,37],[63,31,55,23,61,29,53,21]];for(let t=0;t<l;t++)for(let n=0;n<e/8;n++)for(let a=0;a<8;a++){const f=n*8+a;if(f>=e)break;const i=(t*o.width+f)*4,y=(w.data[i]+w.data[i+1]+w.data[i+2])/3,J=(c[t%8][f%8]-31.5)*2,K=s.threshold+J,F=y<K,Q=s.invert?F?0:1:F?1:0;h[t*e/8+n]|=Q<<7-a}break}case"SierraLite":{const c=new Float32Array(e*l);for(let t=0;t<l;t++)for(let n=0;n<e;n++){const a=(t*o.width+n)*4;c[t*e+n]=(w.data[a]+w.data[a+1]+w.data[a+2])/3}for(let t=0;t<l;t++)for(let n=0;n<e;n++){const a=t*e+n,f=c[a],i=f<s.threshold?0:255;c[a]=i;const y=f-i;n+1<e&&(c[a+1]+=y*2/4),t+1<l&&(n>0&&(c[a+e-1]+=y/4),c[a+e]+=y/4)}for(let t=0;t<l;t++)for(let n=0;n<e/8;n++)for(let a=0;a<8;a++){const f=n*8+a;if(f>=e)break;const i=c[t*e+f]<s.threshold,y=s.invert?i?0:1:i?1:0;h[t*e/8+n]|=y<<7-a}break}}if(o.width!==e)throw new Error(`Canvas width ${o.width} does not match output width ${e}`);return console.log(`Image converted to bits: ${e} pixels wide, ${l} pixels high`),{width:e,height:l,bits:h}}S(q)})();
